.\" Automatically generated by Pod::Man 2.28 (Pod::Simple 3.28)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is turned on, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{
.    if \nF \{
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\"
.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
.    \" fudge factors for nroff and troff
.if n \{\
.    ds #H 0
.    ds #V .8m
.    ds #F .3m
.    ds #[ \f1
.    ds #] \fP
.\}
.if t \{\
.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.    ds #V .6m
.    ds #F 0
.    ds #[ \&
.    ds #] \&
.\}
.    \" simple accents for nroff and troff
.if n \{\
.    ds ' \&
.    ds ` \&
.    ds ^ \&
.    ds , \&
.    ds ~ ~
.    ds /
.\}
.if t \{\
.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.\}
.    \" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.    \" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.    \" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.    ds : e
.    ds 8 ss
.    ds o a
.    ds d- d\h'-1'\(ga
.    ds D- D\h'-1'\(hy
.    ds th \o'bp'
.    ds Th \o'LP'
.    ds ae ae
.    ds Ae AE
.\}
.rm #[ #] #H #V #F C
.\" ========================================================================
.\"
.IX Title "SNAZZER-MEASURE 1"
.TH SNAZZER-MEASURE 1 "2016-10-16" "0.5" "User Contributed Perl Documentation"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
snazzer\-measure \- report shasums & PGP signatures of content under a given path,
along with commands to reproduce or verify data is unchanged
.SH "SYNOPSIS"
.IX Header "SYNOPSIS"
.Vb 1
\&  snazzer\-measure /measured/path [/reported/path] >> path_measurements
.Ve
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
Creates reproducible fingerprints of the given directory, along with commands
necessary (relative to measured path, or if supplied \- the optional reported
path) to reproduce the measurement using only standard core \s-1GNU\s0 userland.
.PP
The output includes:
.IP "\(bu" 4
hostname and datetime of \fBsnazzer-measure\fR invocation
.IP "\(bu" 4
\&\f(CW\*(C`du \-bs\*(C'\fR (bytes used)
.IP "\(bu" 4
\&\f(CW\*(C`sha512sum\*(C'\fR of the result of a reproducible tarball of the directory
.IP "\(bu" 4
\&\f(CW\*(C`gpg2 \-\-armor \-\-sign\*(C'\fR of the same
.IP "\(bu" 4
instructions for reproducing or verifying each of the above
.IP "\(bu" 4
\&\f(CW\*(C`tar \-\-version\*(C'\fR, \f(CW\*(C`tar \-\-show\-defaults\*(C'\fR
.SH "OPTIONS"
.IX Header "OPTIONS"
.IP "\fB\-\-help\fR: Brief help message" 4
.IX Item "--help: Brief help message"
.PD 0
.IP "\fB\-\-man\fR: Full documentation" 4
.IX Item "--man: Full documentation"
.IP "\fB\-\-man\-roff\fR: Full documentation as *roff output, Eg:" 4
.IX Item "--man-roff: Full documentation as *roff output, Eg:"
.PD
.Vb 1
\&    snazzer\-measure \-\-man\-roff | nroff \-man
.Ve
.IP "\fB\-\-man\-markdown\fR: Full documentation as markdown output, Eg:" 4
.IX Item "--man-markdown: Full documentation as markdown output, Eg:"
.Vb 1
\&    snazzer\-measure \-\-man\-markdown > snazzer\-measure\-manpage.md
.Ve
.SH "ENVIRONMENT"
.IX Header "ENVIRONMENT"
.IP "\(bu" 4
snazzer_sig_func
.Sp
Function generating \s-1PGP SIGNATURE\s0 text. Takes input from stdin, output to
stdout. Signatures can be disabled with \s-1SNAZZER_SIG_ENABLE\s0. Default:
.Sp
.Vb 3
\&    snazzer_sig_func() {
\&        gpg2 \-\-quiet \-\-no\-greeting \-\-batch \-\-use\-agent \-\-armor \-\-detach\-sign \-
\&    }
.Ve
.IP "\(bu" 4
\&\s-1SNAZZER_SIG_ENABLE\s0
.Sp
If set to 0, \s-1GPG\s0 signing is disabled and \fIsnazzer_sig_func()\fR is not called.
.IP "\(bu" 4
\&\s-1SNAZZER_MEASUREMENTS_EXCLUDE_FILE\s0
.Sp
A filename within the measured directory of a newline-separated list of shell
glob patterns to exclude from measurements. Default:
.Sp
.Vb 1
\&  SNAZZER_MEASUREMENTS_EXCLUDE_FILE=".snapshot_measurements.exclude"
.Ve
.IP "\(bu" 4
MY_KEYFILES_ARE_INVINCIBLE=1
.Sp
Skip sanity check/abort when gpg secret key exists on a subvolume included in
default snazzer snapshots
.IP "\(bu" 4
\&\s-1SNAZZER_USE_UTC\s0
.Sp
Use \s-1UTC\s0 times of the form \f(CW\*(C`YYYY\-MM\-DDTHHMMSSZ\*(C'\fR instead of the default local
time+offset \f(CW\*(C`YYYY\-MM\-DDTHHMMSS+hhmm\*(C'\fR
.IP "\(bu" 4
\&\s-1SNAZZER_SUBVOLS_EXCLUDE_FILE\s0
.Sp
Filename of newline separated list of shell glob patterns of subvolume pathnames
which should be excluded from \f(CW\*(C`snazzer \-\-all\*(C'\fR invocations; compatible with
\&\f(CW\*(C`\-\-exclude\-from\*(C'\fR for \fBdu\fR and \fBtar\fR.  Examples of subvolume patterns to
exclude from regular snapshotting: *secret*, /var/cache, /var/lib/docker/btrfs,
\&.snapshots.  \fB\s-1NOTE:\s0\fR \f(CW\*(C`.snapshotz\*(C'\fR is always excluded.
Default:
.Sp
.Vb 1
\&  SNAZZER_SUBVOLS_EXCLUDE_FILE="/etc/snazzer/exclude.patterns"
.Ve
.SS "sudo requirements"
.IX Subsection "sudo requirements"
When running \fBsnazzer-measure\fR as a non-root user, certain commands will be
prefixed with \f(CW\*(C`sudo\*(C'\fR. The following lines in \f(CW\*(C`/etc/sudoers\*(C'\fR or
\&\f(CW\*(C`/etc/sudoers.d/snazzer\*(C'\fR should suffice for scripted jobs such as cron (replace
\&\f(CW\*(C`measureuser\*(C'\fR with the actual user name you are setting up for this task):
.PP
.Vb 9
\&    measureuser ALL=(root:nobody) NOPASSWD:NOEXEC: \e
\&        /bin/cat */.snapshotz/*/.snapshot_measurements.exclude, \e
\&        /usr/bin/du \-bs \-\-one\-file\-system \-\-exclude\-from * */.snapshotz/*, \e
\&        /usr/bin/find */.snapshotz/* \e
\&            \-xdev \-not \-path /*/.snapshotz/* \-printf %P\e\e\e\e0, \e
\&        /bin/tar \-\-no\-recursion \-\-one\-file\-system \-\-preserve\-permissions \e
\&            \-\-numeric\-owner \-\-null \-\-create \-\-to\-stdout \e
\&            \-\-directory */.snapshotz/* \-\-files\-from * \e
\&            \-\-exclude\-from */.snapshotz/*/.snapshot_measurements.exclude
.Ve
.SH "EXIT STATUS"
.IX Header "EXIT STATUS"
\&\fBsnazzer-measure\fR will abort with an error message printed to \s-1STDERR\s0 and
non-zero exit status under the following conditions:
.IP "1. Invalid argument" 4
.IX Item "1. Invalid argument"
.PD 0
.IP "2. Path string not specified" 4
.IX Item "2. Path string not specified"
.IP "4. \s-1GPG\s0 signature would have been generated with a secret keyfile stored in a subvolume which has not been excluded from default snazzer snapshots, see \s-1IMPORTANT\s0 below" 4
.IX Item "4. GPG signature would have been generated with a secret keyfile stored in a subvolume which has not been excluded from default snazzer snapshots, see IMPORTANT below"
.IP "5. Expected the .snazzer_measurements.exclude file to contain an entry for the .snazzer_measurements file" 4
.IX Item "5. Expected the .snazzer_measurements.exclude file to contain an entry for the .snazzer_measurements file"
.PD
.SH "IMPORTANT"
.IX Header "IMPORTANT"
Please note that if you are using this tool to gain some form of integrity
measurement (Eg. you want to detect tampering), \s-1GPG\s0 private keys used for the
signing operation mustn't be exposed among the directories being measured.
.PP
Put another way: it makes no sense to GPG-sign measurements of a directory if
those very same directories contain the \s-1GPG\s0 private key material required to
re-sign modifications made by anyone who happens to be looking.
.SH "BUGS AND LIMITATIONS"
.IX Header "BUGS AND LIMITATIONS"
.IP "\(bu" 4
\&\s-1MY_KEYFILES_ARE_INVINCIBLE\s0
.Sp
The sanity check for location of \s-1GPG\s0 secret keyfile may be more annoying than
helpful on installations using smartcards, TPMs, or other methods of protecting
keyfiles \- hence the \fB\s-1MY_KEYFILES_ARE_INVINCIBLE\s0\fR work-around.
.IP "\(bu" 4
Temporary files
.Sp
To avoid unnecessary I/O, gpg signing and shasumming are done in parallel from
the same \f(CW\*(C`tar \-\-to\-stdout\*(C'\fR pipe; this involves creating a temporary named pipe
which is normally removed at the end of a successful run, but will be left
behind should a failure occur. These are randomly named with \f(CW\*(C`mktemp\*(C'\fR and mode
0700, inside a \f(CW\*(C`mktemp \-d\*(C'\fR directory also with 0700 permissions.
.SH "SEE ALSO"
.IX Header "SEE ALSO"
snazzer, snazzer-prune-candidates, snazzer-receive
.SH "AUTHOR"
.IX Header "AUTHOR"
Paul Harvey <csirac2@gmail.com>, https://github.com/csirac2/snazzer
.SH "LICENSE AND COPYRIGHT"
.IX Header "LICENSE AND COPYRIGHT"
Copyright (c) 2015, Paul Harvey <csirac2@gmail.com> All rights reserved.
.PP
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
.PP
1. Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.
.PP
2. Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.
.PP
\&\s-1THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \*(L"AS IS\*(R" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES \s0(\s-1INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES\s0; \s-1LOSS OF USE, DATA, OR PROFITS\s0; \s-1OR BUSINESS INTERRUPTION\s0) \s-1HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT \s0(\s-1INCLUDING NEGLIGENCE OR OTHERWISE\s0) \s-1ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\s0

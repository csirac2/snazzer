.\" Automatically generated by Pod::Man 2.28 (Pod::Simple 3.28)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is turned on, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{
.    if \nF \{
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\"
.\" Accent mark definitions (@(#)ms.acc 1.5 88/02/08 SMI; from UCB 4.2).
.\" Fear.  Run.  Save yourself.  No user-serviceable parts.
.    \" fudge factors for nroff and troff
.if n \{\
.    ds #H 0
.    ds #V .8m
.    ds #F .3m
.    ds #[ \f1
.    ds #] \fP
.\}
.if t \{\
.    ds #H ((1u-(\\\\n(.fu%2u))*.13m)
.    ds #V .6m
.    ds #F 0
.    ds #[ \&
.    ds #] \&
.\}
.    \" simple accents for nroff and troff
.if n \{\
.    ds ' \&
.    ds ` \&
.    ds ^ \&
.    ds , \&
.    ds ~ ~
.    ds /
.\}
.if t \{\
.    ds ' \\k:\h'-(\\n(.wu*8/10-\*(#H)'\'\h"|\\n:u"
.    ds ` \\k:\h'-(\\n(.wu*8/10-\*(#H)'\`\h'|\\n:u'
.    ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'^\h'|\\n:u'
.    ds , \\k:\h'-(\\n(.wu*8/10)',\h'|\\n:u'
.    ds ~ \\k:\h'-(\\n(.wu-\*(#H-.1m)'~\h'|\\n:u'
.    ds / \\k:\h'-(\\n(.wu*8/10-\*(#H)'\z\(sl\h'|\\n:u'
.\}
.    \" troff and (daisy-wheel) nroff accents
.ds : \\k:\h'-(\\n(.wu*8/10-\*(#H+.1m+\*(#F)'\v'-\*(#V'\z.\h'.2m+\*(#F'.\h'|\\n:u'\v'\*(#V'
.ds 8 \h'\*(#H'\(*b\h'-\*(#H'
.ds o \\k:\h'-(\\n(.wu+\w'\(de'u-\*(#H)/2u'\v'-.3n'\*(#[\z\(de\v'.3n'\h'|\\n:u'\*(#]
.ds d- \h'\*(#H'\(pd\h'-\w'~'u'\v'-.25m'\f2\(hy\fP\v'.25m'\h'-\*(#H'
.ds D- D\\k:\h'-\w'D'u'\v'-.11m'\z\(hy\v'.11m'\h'|\\n:u'
.ds th \*(#[\v'.3m'\s+1I\s-1\v'-.3m'\h'-(\w'I'u*2/3)'\s-1o\s+1\*(#]
.ds Th \*(#[\s+2I\s-2\h'-\w'I'u*3/5'\v'-.3m'o\v'.3m'\*(#]
.ds ae a\h'-(\w'a'u*4/10)'e
.ds Ae A\h'-(\w'A'u*4/10)'E
.    \" corrections for vroff
.if v .ds ~ \\k:\h'-(\\n(.wu*9/10-\*(#H)'\s-2\u~\d\s+2\h'|\\n:u'
.if v .ds ^ \\k:\h'-(\\n(.wu*10/11-\*(#H)'\v'-.4m'^\v'.4m'\h'|\\n:u'
.    \" for low resolution devices (crt and lpr)
.if \n(.H>23 .if \n(.V>19 \
\{\
.    ds : e
.    ds 8 ss
.    ds o a
.    ds d- d\h'-1'\(ga
.    ds D- D\h'-1'\(hy
.    ds th \o'bp'
.    ds Th \o'LP'
.    ds ae ae
.    ds Ae AE
.\}
.rm #[ #] #H #V #F C
.\" ========================================================================
.\"
.IX Title "SNAZZER 1"
.TH SNAZZER 1 "2016-10-16" "0.2" "User Contributed Perl Documentation"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
snazzer \- create read\-only "/subvol/.snapshotz/[isodate]" btrfs snapshots,
offers snapshot pruning and measurement
.SH "SYNOPSIS"
.IX Header "SYNOPSIS"
.Vb 1
\&  snazzer [\-\-prune|\-\-measure [\-\-force ]] [\-\-dry\-run] \-\-all
\&
\&  snazzer [\-\-prune|\-\-measure [\-\-force ]] [\-\-dry\-run] \-\-all [mountpoint]
\&
\&  snazzer [\-\-prune|\-\-measure [\-\-force ]] [\-\-dry\-run] subvol1 [subvol2 [...]]
.Ve
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
Examples:
.PP
Snapshot all non-excluded subvols on all mounted btrfs filesystems:
.PP
.Vb 1
\&  snazzer \-\-all
.Ve
.PP
Prune all non-excluded subvols on all mounted btrfs filesystems:
.PP
.Vb 1
\&  snazzer \-\-prune \-\-force \-\-all
.Ve
.PP
Append output of \fBsnazzer-measure\fR to
\&\f(CW\*(C`/path/to/subvol/.snapshotz/.measurements/[isodate]\*(C'\fR for all snapshots of all
subvolumes on all mounted btrfs filesytems (slow!):
.PP
.Vb 1
\&  snazzer \-\-measure \-\-force \-\-all
.Ve
.PP
As above, skipping snapshots already measured by this host (recommended):
.PP
.Vb 1
\&  snazzer \-\-measure \-\-all
.Ve
.PP
Print rather than execute commands for snapshotting all non-excluded subvols for
the filesystem mounted at /mnt (including /mnt itself):
.PP
.Vb 1
\&  snazzer \-\-dry\-run \-\-all /mnt
.Ve
.PP
Prune only the explicitly named subvols at /srv, /var/log and root:
.PP
.Vb 1
\&  snazzer \-\-prune /srv /var/log /
.Ve
.SH "OPTIONS"
.IX Header "OPTIONS"
.IP "\fB\-\-all\fR \fB[mountpoint]\fR: act on all subvolumes under mountpoint. If mountpoint is omitted, \fBsnazzer\fR acts on all mounted btrfs filesystems." 4
.IX Item "--all [mountpoint]: act on all subvolumes under mountpoint. If mountpoint is omitted, snazzer acts on all mounted btrfs filesystems."
.PD 0
.IP "\fB\-\-prune\fR: delete rather than create snapshots. Exactly which are no longer needed is \fBsnazzer-prune-candidates\fR's role, documented separately" 4
.IX Item "--prune: delete rather than create snapshots. Exactly which are no longer needed is snazzer-prune-candidates's role, documented separately"
.ie n .IP "\fB\-\-measure\fR: append output of \fBsnazzer-measure\fR to ""/path/to/subvol/.snapshotz/.measurements/[isodate]"" By default, only snapshots which haven't been measured by this hostname are updated \- use \fB\-\-force\fR to measure all snapshots" 4
.el .IP "\fB\-\-measure\fR: append output of \fBsnazzer-measure\fR to \f(CW/path/to/subvol/.snapshotz/.measurements/[isodate]\fR By default, only snapshots which haven't been measured by this hostname are updated \- use \fB\-\-force\fR to measure all snapshots" 4
.IX Item "--measure: append output of snazzer-measure to /path/to/subvol/.snapshotz/.measurements/[isodate] By default, only snapshots which haven't been measured by this hostname are updated - use --force to measure all snapshots"
.IP "\fB\-\-force\fR: required for \fB\-\-prune\fR to carry out any pruning operation. For \fB\-\-measure\fR, this switch overrides the default behaviour of skipping snapshots already measured by current hostname" 4
.IX Item "--force: required for --prune to carry out any pruning operation. For --measure, this switch overrides the default behaviour of skipping snapshots already measured by current hostname"
.IP "\fB\-\-list\-subvolumes\fR: list subvolumes that would be acted on" 4
.IX Item "--list-subvolumes: list subvolumes that would be acted on"
.IP "\fB\-\-list\-snapshots\fR: list snapshots under subvolumes as above" 4
.IX Item "--list-snapshots: list snapshots under subvolumes as above"
.IP "\fB\-\-dry\-run\fR: print rather than execute commands that would be run" 4
.IX Item "--dry-run: print rather than execute commands that would be run"
.IP "\fB\-\-help\fR: Brief help message" 4
.IX Item "--help: Brief help message"
.IP "\fB\-\-man\fR: Full documentation" 4
.IX Item "--man: Full documentation"
.IP "\fB\-\-man\-roff\fR: Full documentation as *roff output, Eg:" 4
.IX Item "--man-roff: Full documentation as *roff output, Eg:"
.PD
.Vb 1
\&    snazzer \-\-man\-roff | nroff \-man
.Ve
.IP "\fB\-\-man\-markdown\fR: Full documentation as markdown output, Eg:" 4
.IX Item "--man-markdown: Full documentation as markdown output, Eg:"
.Vb 1
\&    snazzer \-\-man\-markdown > snazzer\-manpage.md
.Ve
.ie n .IP "\fB\-\-generate\-test\-img\fR ""file.img"": create btrfs image for testing" 4
.el .IP "\fB\-\-generate\-test\-img\fR \f(CWfile.img\fR: create btrfs image for testing" 4
.IX Item "--generate-test-img file.img: create btrfs image for testing"
.SH "ENVIRONMENT"
.IX Header "ENVIRONMENT"
.PD 0
.IP "\(bu" 4
.PD
\&\s-1SNAZZER_SUBVOLS_EXCLUDE_FILE\s0
.Sp
Filename of newline separated list of shell glob patterns of subvolume pathnames
which should be excluded from \f(CW\*(C`snazzer \-\-all\*(C'\fR invocations; compatible with
\&\f(CW\*(C`\-\-exclude\-from\*(C'\fR for \fBdu\fR and \fBtar\fR.  Examples of subvolume patterns to
exclude from regular snapshotting: *secret*, /var/cache, /var/lib/docker/btrfs,
\&.snapshots.  \fB\s-1NOTE:\s0\fR \f(CW\*(C`.snapshotz\*(C'\fR is always excluded.
Default:
.Sp
.Vb 1
\&  SNAZZER_SUBVOLS_EXCLUDE_FILE="/etc/snazzer/exclude.patterns"
.Ve
.IP "\(bu" 4
SNAZZER_USE_UTC=1
.Sp
For snapshot naming and \fBsnazzer-measure\fR output use \s-1UTC\s0 times of the form
\&\f(CW\*(C`YYYY\-MM\-DDTHHMMSSZ\*(C'\fR instead of local time+offset \f(CW\*(C`YYYY\-MM\-DDTHHMMSS+hhmm\*(C'\fR
.SH "BUGS AND LIMITATIONS"
.IX Header "BUGS AND LIMITATIONS"
.IP "\(bu" 4
Snapshot naming
.Sp
A choice has been made to mint a single datetime string which is used for all
snapshot names in a given \fBsnazzer\fR snapshot invocation, regardless of how long
or at which exact time the snapshotting process takes place for each subvolume.
This makes for consistency across all subvolumes and filesystems, so that
identifying which snapshots were part of a given snapshotting run is possible.
If the actual datetime of the snapshot event is important to you, this is
available from the \f(CW\*(C`btrfs subvolume show\*(C'\fR command.
.IP "\(bu" 4
\&\s-1SNAZZER_SUBVOLS_EXCLUDE_FILE\s0 is used with grep \-f
.Sp
A minimal (possibly buggy/incomplete) attempt is made to convert the shell glob
patterns in this file to a regex suitable for grep \-f. The assumption is that
the exclude patterns file should only contain \*(L"boring\*(R" paths. Obvious regex
characters are escaped, however there are likely hostile path glob patterns
which will break things.
.IP "\(bu" 4
\&.snapshot_measurements.exclude is a work-around to the btrfs atime bug
.Sp
Snapshots may include empty directories under which some other subvol may have
existed in the original, snapshotted subvolume. However, btrfs has a bug where
these empty directories behave differently to empty directories created with
\&\f(CW\*(C`mkdir\*(C'\fR: atimes always return with the current local time, which is obvioulsy
different from one second to the next. So we have no hope of creating
reproducible shasums or \s-1PGP\s0 signatures unless those directories are excluded
from our measurements of the snapshot. See also: 
<https://bugzilla.kernel.org/show_bug.cgi?id=95201>
.SH "EXIT STATUS"
.IX Header "EXIT STATUS"
\&\fBsnazzer\fR will abort with an error message printed to \s-1STDERR\s0 and non-zero exit
status under the following conditions:
.IP "1. invalid arguments" 4
.IX Item "1. invalid arguments"
.PD 0
.IP "2. path is not a filesystem mountpoint" 4
.IX Item "2. path is not a filesystem mountpoint"
.IP "3. one or more paths were not btrfs subvolumes" 4
.IX Item "3. one or more paths were not btrfs subvolumes"
.IP "4. prune expected /path/to/subvol/.snapshotz directory which was missing" 4
.IX Item "4. prune expected /path/to/subvol/.snapshotz directory which was missing"
.IP "5. prune expected \-\-dry\-run or \-\-force" 4
.IX Item "5. prune expected --dry-run or --force"
.IP "6. tried to write a .snapshot_measurements.exclude file in the snapshot root, but it already exists in the current subvolume" 4
.IX Item "6. tried to write a .snapshot_measurements.exclude file in the snapshot root, but it already exists in the current subvolume"
.IP "7. tried to perform snapshot measurements while existing measurements are already in progress, check lock dir at /var/run/snazzer\-measure.lock" 4
.IX Item "7. tried to perform snapshot measurements while existing measurements are already in progress, check lock dir at /var/run/snazzer-measure.lock"
.IP "9. tried to display man page with a formatter which is not installed" 4
.IX Item "9. tried to display man page with a formatter which is not installed"
.ie n .IP "10. missing ""snazzer\-measure"" or ""snazzer\-prune\-candidates"" from \s-1PATH\s0" 4
.el .IP "10. missing \f(CWsnazzer\-measure\fR or \f(CWsnazzer\-prune\-candidates\fR from \s-1PATH\s0" 4
.IX Item "10. missing snazzer-measure or snazzer-prune-candidates from PATH"
.ie n .IP "11. missing ""btrfs"" command from \s-1PATH\s0" 4
.el .IP "11. missing \f(CWbtrfs\fR command from \s-1PATH\s0" 4
.IX Item "11. missing btrfs command from PATH"
.PD
.SH "SEE ALSO"
.IX Header "SEE ALSO"
snazzer-measure, snazzer-prune-candidates, snazzer-receive
.SH "AUTHOR"
.IX Header "AUTHOR"
Paul Harvey <csirac2@gmail.com>, https://github.com/csirac2/snazzer
.SH "LICENSE AND COPYRIGHT"
.IX Header "LICENSE AND COPYRIGHT"
Copyright (c) 2015, Paul Harvey <csirac2@gmail.com> All rights reserved.
.PP
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
.PP
1. Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.
.PP
2. Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.
.PP
\&\s-1THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \*(L"AS IS\*(R" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
DAMAGES \s0(\s-1INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
SERVICES\s0; \s-1LOSS OF USE, DATA, OR PROFITS\s0; \s-1OR BUSINESS INTERRUPTION\s0) \s-1HOWEVER
CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
OR TORT \s0(\s-1INCLUDING NEGLIGENCE OR OTHERWISE\s0) \s-1ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\s0
